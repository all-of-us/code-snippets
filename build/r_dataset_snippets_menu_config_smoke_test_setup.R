#!/usr/bin/env Rscript

# This cohort was created using Dataset Builder on 11/12/2019.

# Feel free to update it with a new/different cohort, but please follow these two caveats:
#  1) keep the number of members below 5000 so that the smoke test runs relatively quickly
#  2) update dataset prefixes from values like 'dataset_123456789' to 'YOUR_DATASET_NAME'

# In practice, users of the snippets will do the opposite replacement, but here we want to
# check that the snippets are consistently using the 'YOUR_DATASET_NAME' prefix.


if(! "reticulate" %in% installed.packages()) { install.packages("reticulate") }
library(reticulate)
pd <- reticulate::import("pandas")

# The ‘max_number_of_rows’ parameter limits the number of rows in the query so that the result set can fit in memory.
# If you increase the limit and run into responsiveness issues, please request a VM size upgrade.
max_number_of_rows = '1000000'

# This query represents dataset "dataSet" for domain "measurement"
YOUR_DATASET_NAME_measurement_sql <- paste("SELECT measurement.UNIT_CONCEPT_ID, measurement.MEASUREMENT_SOURCE_CONCEPT_ID, measurement.RANGE_LOW, measurement.MEASUREMENT_TYPE_CONCEPT_ID, measurement.MEASUREMENT_SOURCE_VALUE, measurement.PERSON_ID, measurement.VALUE_AS_NUMBER, measurement.MEASUREMENT_CONCEPT_ID, measurement.MEASUREMENT_DATETIME, measurement.VALUE_AS_CONCEPT_ID, measurement.OPERATOR_CONCEPT_ID, measurement.VISIT_OCCURRENCE_ID, measurement.VALUE_SOURCE_VALUE, measurement.RANGE_HIGH, measurement.UNIT_SOURCE_VALUE, m_unit.concept_name as UNIT_CONCEPT_NAME, m_value.concept_name as VALUE_AS_CONCEPT_NAME, m_operator.concept_name as OPERATOR_CONCEPT_NAME, m_type.concept_name as MEASUREMENT_TYPE_CONCEPT_NAME, m_standard_concept.vocabulary_id as STANDARD_VOCABULARY, m_standard_concept.concept_code as STANDARD_CONCEPT_CODE, m_standard_concept.concept_name as STANDARD_CONCEPT_NAME, m_source_concept.vocabulary_id as SOURCE_VOCABULARY, m_source_concept.concept_name as SOURCE_CONCEPT_NAME, m_source_concept.concept_code as SOURCE_CONCEPT_CODE, m_visit.concept_name as VISIT_OCCURRENCE_CONCEPT_NAME from `fc-aou-cdr-prod.R2019Q4R3.measurement` measurement left join `fc-aou-cdr-prod.R2019Q4R3.concept` m_unit on measurement.unit_concept_id = m_unit.concept_id left join `fc-aou-cdr-prod.R2019Q4R3.concept` m_value on measurement.value_as_concept_id = m_value.concept_id left join `fc-aou-cdr-prod.R2019Q4R3.concept` m_operator on measurement.operator_concept_id = m_operator.concept_id left join `fc-aou-cdr-prod.R2019Q4R3.concept` m_type on measurement.measurement_type_concept_id = m_type.concept_id left join `fc-aou-cdr-prod.R2019Q4R3.concept` m_standard_concept on measurement.measurement_concept_id = m_standard_concept.concept_id left join `fc-aou-cdr-prod.R2019Q4R3.concept` m_source_concept on measurement.measurement_source_concept_id = m_source_concept.concept_id left join `fc-aou-cdr-prod.R2019Q4R3.visit_occurrence` v on measurement.visit_occurrence_id = v.visit_occurrence_id left join `fc-aou-cdr-prod.R2019Q4R3.concept` m_visit on v.visit_concept_id = m_visit.concept_id WHERE
(measurement_concept_id IN (3022318, 903118, 3027018, 903115, 40759207, 903136, 3025315, 3031203, 903107, 3019550, 3023103, 903135, 40765148, 3004249, 3012888, 3006906, 3038553, 903126, 3036277, 3013682) OR
measurement_source_concept_id IN (3022318, 903118, 3027018, 903115, 40759207, 903136, 3025315, 3031203, 903107, 3019550, 3023103, 903135, 40765148, 3004249, 3012888, 3006906, 3038553, 903126, 3036277, 3013682))
AND (measurement.PERSON_ID IN (select person_id
from `fc-aou-cdr-prod.R2019Q4R3.person` person
where
person.person_id in (select criteria.person_id from (select distinct person_id, entry_date, concept_id
from `fc-aou-cdr-prod.R2019Q4R3.cb_search_all_events`
where ((is_standard = @p0_586 and concept_id in unnest(@p1_586))
)
) criteria
)
))
LIMIT ", max_number_of_rows)

YOUR_DATASET_NAME_measurement_query_config <- list(
  query = list(
    parameterMode = 'NAMED',
    queryParameters = list(
      list(
        name = "p1_586",
        parameterType = list(type = "ARRAY", arrayType = list(type = "INT64")),
        parameterValue = list(arrayValues = list(list(value = 261255),list(value = 256646),list(value = 4092216),list(value = 4092217),list(value = 4311501),list(value = 255507),list(value = 257825),list(value = 4094876),list(value = 4089756),list(value = 4089754),list(value = 37110034),list(value = 36712981),list(value = 37110032),list(value = 37110033),list(value = 4246126),list(value = 762427),list(value = 4157454),list(value = 762426),list(value = 433973),list(value = 45768846),list(value = 45768844),list(value = 4093960),list(value = 46273652),list(value = 4312567),list(value = 37110031),list(value = 4112770),list(value = 36712816),list(value = 4054524),list(value = 4131454),list(value = 4110591),list(value = 258369),list(value = 4131453),list(value = 4110588),list(value = 4054526),list(value = 4110586),list(value = 258375),list(value = 4110587),list(value = 4128889),list(value = 4128888),list(value = 4128887),list(value = 4246027),list(value = 4110706),list(value = 4110705),list(value = 43530696),list(value = 4213396),list(value = 4055272),list(value = 4246805),list(value = 4247832),list(value = 4129381),list(value = 4129380),list(value = 4112738),list(value = 46270492),list(value = 36712815),list(value = 760916),list(value = 40492938),list(value = 257513),list(value = 4151250),list(value = 45768916),list(value = 4310703),list(value = 45768917),list(value = 4242353),list(value = 4115276),list(value = 45769033),list(value = 46270513),list(value = 254583),list(value = 261236),list(value = 443388),list(value = 42539251),list(value = 254591),list(value = 37109576)))
      ),
      list(
        name = "p0_586",
        parameterType = list(type = "INT64"),
        parameterValue = list(value = "1")
      )
    )
  )
)

YOUR_DATASET_NAME_measurement_df <- pd$read_gbq(YOUR_DATASET_NAME_measurement_sql, dialect="standard", configuration=YOUR_DATASET_NAME_measurement_query_config)

head(YOUR_DATASET_NAME_measurement_df, 5)

if(! "reticulate" %in% installed.packages()) { install.packages("reticulate") }
library(reticulate)
pd <- reticulate::import("pandas")

# The ‘max_number_of_rows’ parameter limits the number of rows in the query so that the result set can fit in memory.
# If you increase the limit and run into responsiveness issues, please request a VM size upgrade.
max_number_of_rows = '1000000'

# This query represents dataset "dataSet" for domain "survey"
YOUR_DATASET_NAME_survey_sql <- paste("SELECT answer.question, answer.survey, answer.survey_datetime, answer.answer_concept_id, answer.question_concept_id, answer.person_id, answer.answer    FROM `fc-aou-cdr-prod.R2019Q4R3.ds_survey` answer WHERE
(question_concept_id IN (1586159, 1585864, 1586162, 1585656, 1585873, 1585870, 1585698, 903058, 1586185, 1586169, 1585686, 1586177, 1585692, 1585680, 1585867, 1585674, 1586193, 1585668, 1585704, 1586207, 1585860, 1586182, 1586201, 1585636, 1586213, 1586174, 1585650, 1585857, 1586190, 1586166, 1586198, 1586135, 1585892, 1585370, 1586140, 1585845, 1585879, 1585375, 1585940, 1585838, 1585899, 1585889, 1585386, 1585890, 1585952, 1585886, 43528428, 43528652, 43528512, 43528513, 43528511, 43528510, 43528509, 43528514, 43529765, 43529762, 43529191, 43529763, 43529764, 43529766, 43529634, 43529636, 43529637, 43529633, 43529635, 43529632, 43529155, 43529152, 43529153, 43529156, 43529157, 43529154, 43528628, 43528631, 43528633, 43528630, 43528629, 702788, 43528562, 43528558, 43528561, 43528559, 43528560, 43528917, 43529962, 43529964, 43529961, 43529963, 43529960, 43529965, 43528674, 43528676, 43528675, 43528944, 702783, 43528677, 43529814, 43528487, 43529813, 43528486, 43529811, 43529812, 43528490, 43529269, 43528489, 43529270, 43529271, 43529268, 43530563, 43529215, 43529213, 43529214, 43529218, 43529216, 1585795, 1585820, 1585796, 1585802, 1585791, 1585789, 1585806, 1585811, 1585803, 1585711, 1585784, 1585717, 1585723, 1585748, 1585766, 1585772, 1585815, 1585735, 1585729, 1585747, 1585760, 1585778, 1585741, 1585754, 43530468, 43530387, 43528793, 43530502, 43530532, 1384621, 43530365, 43528843, 43528842, 43530530, 1384572, 1384601, 43530521, 1384538, 1384478, 43530310, 1384647, 43530318, 43528866, 43528788, 43530489, 1384667, 43530496, 43528809, 43530381, 43530494, 43528873, 1384635, 43530307, 1384625, 1384617, 1384410, 43528835, 1384608, 43528831, 43528822, 1384587, 43530363, 43528790, 43530552, 43530357, 43528829, 1384432, 1384514, 43528834, 1384663, 43530473, 43528855, 1384420, 43530312, 43530311, 43530378, 43530540, 43530499, 43528802, 43528828, 43530383, 1384605, 43530375, 1384542, 43530370, 1384474, 43530510, 43530325, 43530548, 43530372, 1384535, 43530453, 43530514, 43530315, 43528791, 43530291, 1384388, 43528807, 43530542, 1384456, 1384584, 43528860, 1384494, 43528823, 43530282, 43530385, 43530462, 43528844, 43530304, 1384401, 43530396, 43530516, 43530495, 43530330, 43530478, 43530527, 43530507, 1384479, 43528871, 43528832, 1384641, 43528859, 43528799, 43528798, 43530380, 43528877, 1384399, 43530498, 43530398, 1384540, 43530395, 1384609, 1384661, 1384570, 43528827, 1384462, 43530500, 43530479, 43530486, 43528868, 43528787, 43530351, 43530326, 1384528, 43528815, 43528867, 43530487, 43530466, 43530338, 43530384, 43530501, 43528783, 43528789, 1384509, 43530543, 43530342, 1384530, 1384470, 1384576, 43528872, 1384468, 43530485, 1384593, 1384480, 43528870, 1384493, 1384438, 43530341, 43530393, 43530306, 43530471, 43530394, 1384554, 43530509, 1384501, 1384465, 43530539, 43528806, 1384505, 43528800, 43530298, 43530515, 1384566, 1384649, 1384543, 43530523, 1384636, 43530348, 43530505, 43530354, 43530517, 43530467, 43530345, 1384442, 43530465, 1384393, 43530511, 43530497, 43528836, 43528766, 43530308, 1384511, 43530316, 43530481, 1384637, 1384460, 1384671, 43528785, 43530538, 43530463, 43528816, 1384627, 1384553, 43528839, 43530457, 43528786, 43528830, 1384660, 43530474, 43528878, 43530556, 43530286, 43528856, 1384463, 43530359, 43530379, 43530461, 43530455, 43530448, 43530303, 43530476, 43530390, 43530519, 43530285, 1384611, 43530528, 1384668, 43530321, 43528880, 43528808, 43528826, 43528825, 43528817, 43530299, 1384394, 43530524, 43530332, 43528853, 43530305, 43528775, 43530386, 43530300, 1384573, 1384476, 1384409, 43528801, 43530344, 43528824, 1384423, 1384589, 43528814, 43530356, 43530541, 43530358, 43530555, 43530309, 43530343, 43530361, 1384398, 1384655, 43530551, 43530353, 1384560, 43530382, 43528854, 43528784, 43528770, 43530553, 43528805, 43530290, 43530314, 43530444, 43530477, 1384466, 43528848, 43530288, 43530550, 43530480, 1384489, 43530324, 43528838, 43530296, 43528821, 43530482, 43530336, 43528841, 43530392, 43528851, 43530526, 43528846, 43530414, 1384437, 1384672, 43530327, 1384556, 43528819, 43530537, 43530294, 43528837, 43530322, 43528810, 43530529, 43530451, 43530283, 1384490, 43530371, 43530546, 43530369, 43530366, 43528862, 43528792, 1384651, 1384518, 43530302, 1384425, 43530317, 43530533, 43528865, 43530377, 43530475, 43530464, 43528820, 43530484, 43530340, 43530545, 43528869, 1384416, 1384517, 43528804, 43530492, 1384620, 43530349, 43530472, 43528883, 43528850, 43528879, 1384433, 43530337, 43528780, 43530512, 43528882, 43528813, 43530397, 43530544, 43530339, 43530469, 43530483, 43528875, 1384507, 1384448, 43528796, 43530388, 43530329, 43528795, 43530347, 43530508, 1384619, 1384612, 43530452, 1384569, 43530445, 43530323, 43530442, 43528833, 43530360, 43530488, 43528847, 43530367, 43528769, 43530346, 1384539, 1384633, 43530554, 43530518, 43528864, 43530456, 43528767, 43530301, 1384486, 1384552, 43530446, 43530319, 43528812, 43530536, 1384630, 43528772, 1384645, 43530441, 43530443, 43530295, 43530293, 1384506, 1384624, 1384447, 43528774, 1384426, 1384628, 43528778, 43530334, 43530493, 43530440, 43530520, 43530328, 43530491, 43530350, 1384513, 43528768, 1384483, 43530454, 1384652, 43530506, 1384418, 43530503, 43528857, 1384574, 43530313, 43530470, 1384626, 43530297, 1384424, 43528811, 43530292, 43528858, 43530331, 43530289, 43530373, 43530352, 43528852, 1384431, 1384451, 43528779, 43530458, 43528782, 43528773, 1384597, 43530284, 43530525, 1384482, 43530447, 1384492, 43528776, 43528781, 43530449, 43530459, 43530450, 43528797, 1384529, 1384670, 43528777, 1384642, 43530368, 43530320, 43530335, 43528771, 43530287, 43528863, 43528845, 43528881, 1384532, 1384664, 43530362, 43530531, 43530374, 1384459, 1384602, 1384596, 1384537, 43528757, 1384522, 1384430, 43528759, 1384526, 43528760, 1384662, 1384495, 1384487, 1384592, 1384390, 43528758, 43529978, 43529975, 43530559, 43530593, 43530592, 43530400, 43530590, 43530437, 43529976, 43530405, 43530410, 43530583, 43530409, 43529905, 43528662, 43530562, 43529899, 43529973, 43530595, 43528666, 43530439, 43528663, 43529906, 43530416, 43530402, 43530584, 43530557, 43529903, 43530438, 43530415, 43530588, 43529977, 43530591, 43530417, 43530589, 43530594, 43529974, 43530406, 43529901, 43530407, 43530418, 43528661, 43530408, 43530585, 43529904, 43530403, 43530404, 43528665, 43530412, 43528660, 43530411, 43528664, 43529902, 43530401, 43530399, 43530268, 43530413) OR
answer_concept_id IN (1586159, 1585864, 1586162, 1585656, 1585873, 1585870, 1585698, 903058, 1586185, 1586169, 1585686, 1586177, 1585692, 1585680, 1585867, 1585674, 1586193, 1585668, 1585704, 1586207, 1585860, 1586182, 1586201, 1585636, 1586213, 1586174, 1585650, 1585857, 1586190, 1586166, 1586198, 1586135, 1585892, 1585370, 1586140, 1585845, 1585879, 1585375, 1585940, 1585838, 1585899, 1585889, 1585386, 1585890, 1585952, 1585886, 43528428, 43528652, 43528512, 43528513, 43528511, 43528510, 43528509, 43528514, 43529765, 43529762, 43529191, 43529763, 43529764, 43529766, 43529634, 43529636, 43529637, 43529633, 43529635, 43529632, 43529155, 43529152, 43529153, 43529156, 43529157, 43529154, 43528628, 43528631, 43528633, 43528630, 43528629, 702788, 43528562, 43528558, 43528561, 43528559, 43528560, 43528917, 43529962, 43529964, 43529961, 43529963, 43529960, 43529965, 43528674, 43528676, 43528675, 43528944, 702783, 43528677, 43529814, 43528487, 43529813, 43528486, 43529811, 43529812, 43528490, 43529269, 43528489, 43529270, 43529271, 43529268, 43530563, 43529215, 43529213, 43529214, 43529218, 43529216, 1585795, 1585820, 1585796, 1585802, 1585791, 1585789, 1585806, 1585811, 1585803, 1585711, 1585784, 1585717, 1585723, 1585748, 1585766, 1585772, 1585815, 1585735, 1585729, 1585747, 1585760, 1585778, 1585741, 1585754, 43530468, 43530387, 43528793, 43530502, 43530532, 1384621, 43530365, 43528843, 43528842, 43530530, 1384572, 1384601, 43530521, 1384538, 1384478, 43530310, 1384647, 43530318, 43528866, 43528788, 43530489, 1384667, 43530496, 43528809, 43530381, 43530494, 43528873, 1384635, 43530307, 1384625, 1384617, 1384410, 43528835, 1384608, 43528831, 43528822, 1384587, 43530363, 43528790, 43530552, 43530357, 43528829, 1384432, 1384514, 43528834, 1384663, 43530473, 43528855, 1384420, 43530312, 43530311, 43530378, 43530540, 43530499, 43528802, 43528828, 43530383, 1384605, 43530375, 1384542, 43530370, 1384474, 43530510, 43530325, 43530548, 43530372, 1384535, 43530453, 43530514, 43530315, 43528791, 43530291, 1384388, 43528807, 43530542, 1384456, 1384584, 43528860, 1384494, 43528823, 43530282, 43530385, 43530462, 43528844, 43530304, 1384401, 43530396, 43530516, 43530495, 43530330, 43530478, 43530527, 43530507, 1384479, 43528871, 43528832, 1384641, 43528859, 43528799, 43528798, 43530380, 43528877, 1384399, 43530498, 43530398, 1384540, 43530395, 1384609, 1384661, 1384570, 43528827, 1384462, 43530500, 43530479, 43530486, 43528868, 43528787, 43530351, 43530326, 1384528, 43528815, 43528867, 43530487, 43530466, 43530338, 43530384, 43530501, 43528783, 43528789, 1384509, 43530543, 43530342, 1384530, 1384470, 1384576, 43528872, 1384468, 43530485, 1384593, 1384480, 43528870, 1384493, 1384438, 43530341, 43530393, 43530306, 43530471, 43530394, 1384554, 43530509, 1384501, 1384465, 43530539, 43528806, 1384505, 43528800, 43530298, 43530515, 1384566, 1384649, 1384543, 43530523, 1384636, 43530348, 43530505, 43530354, 43530517, 43530467, 43530345, 1384442, 43530465, 1384393, 43530511, 43530497, 43528836, 43528766, 43530308, 1384511, 43530316, 43530481, 1384637, 1384460, 1384671, 43528785, 43530538, 43530463, 43528816, 1384627, 1384553, 43528839, 43530457, 43528786, 43528830, 1384660, 43530474, 43528878, 43530556, 43530286, 43528856, 1384463, 43530359, 43530379, 43530461, 43530455, 43530448, 43530303, 43530476, 43530390, 43530519, 43530285, 1384611, 43530528, 1384668, 43530321, 43528880, 43528808, 43528826, 43528825, 43528817, 43530299, 1384394, 43530524, 43530332, 43528853, 43530305, 43528775, 43530386, 43530300, 1384573, 1384476, 1384409, 43528801, 43530344, 43528824, 1384423, 1384589, 43528814, 43530356, 43530541, 43530358, 43530555, 43530309, 43530343, 43530361, 1384398, 1384655, 43530551, 43530353, 1384560, 43530382, 43528854, 43528784, 43528770, 43530553, 43528805, 43530290, 43530314, 43530444, 43530477, 1384466, 43528848, 43530288, 43530550, 43530480, 1384489, 43530324, 43528838, 43530296, 43528821, 43530482, 43530336, 43528841, 43530392, 43528851, 43530526, 43528846, 43530414, 1384437, 1384672, 43530327, 1384556, 43528819, 43530537, 43530294, 43528837, 43530322, 43528810, 43530529, 43530451, 43530283, 1384490, 43530371, 43530546, 43530369, 43530366, 43528862, 43528792, 1384651, 1384518, 43530302, 1384425, 43530317, 43530533, 43528865, 43530377, 43530475, 43530464, 43528820, 43530484, 43530340, 43530545, 43528869, 1384416, 1384517, 43528804, 43530492, 1384620, 43530349, 43530472, 43528883, 43528850, 43528879, 1384433, 43530337, 43528780, 43530512, 43528882, 43528813, 43530397, 43530544, 43530339, 43530469, 43530483, 43528875, 1384507, 1384448, 43528796, 43530388, 43530329, 43528795, 43530347, 43530508, 1384619, 1384612, 43530452, 1384569, 43530445, 43530323, 43530442, 43528833, 43530360, 43530488, 43528847, 43530367, 43528769, 43530346, 1384539, 1384633, 43530554, 43530518, 43528864, 43530456, 43528767, 43530301, 1384486, 1384552, 43530446, 43530319, 43528812, 43530536, 1384630, 43528772, 1384645, 43530441, 43530443, 43530295, 43530293, 1384506, 1384624, 1384447, 43528774, 1384426, 1384628, 43528778, 43530334, 43530493, 43530440, 43530520, 43530328, 43530491, 43530350, 1384513, 43528768, 1384483, 43530454, 1384652, 43530506, 1384418, 43530503, 43528857, 1384574, 43530313, 43530470, 1384626, 43530297, 1384424, 43528811, 43530292, 43528858, 43530331, 43530289, 43530373, 43530352, 43528852, 1384431, 1384451, 43528779, 43530458, 43528782, 43528773, 1384597, 43530284, 43530525, 1384482, 43530447, 1384492, 43528776, 43528781, 43530449, 43530459, 43530450, 43528797, 1384529, 1384670, 43528777, 1384642, 43530368, 43530320, 43530335, 43528771, 43530287, 43528863, 43528845, 43528881, 1384532, 1384664, 43530362, 43530531, 43530374, 1384459, 1384602, 1384596, 1384537, 43528757, 1384522, 1384430, 43528759, 1384526, 43528760, 1384662, 1384495, 1384487, 1384592, 1384390, 43528758, 43529978, 43529975, 43530559, 43530593, 43530592, 43530400, 43530590, 43530437, 43529976, 43530405, 43530410, 43530583, 43530409, 43529905, 43528662, 43530562, 43529899, 43529973, 43530595, 43528666, 43530439, 43528663, 43529906, 43530416, 43530402, 43530584, 43530557, 43529903, 43530438, 43530415, 43530588, 43529977, 43530591, 43530417, 43530589, 43530594, 43529974, 43530406, 43529901, 43530407, 43530418, 43528661, 43530408, 43530585, 43529904, 43530403, 43530404, 43528665, 43530412, 43528660, 43530411, 43528664, 43529902, 43530401, 43530399, 43530268, 43530413))
AND (answer.PERSON_ID IN (select person_id
from `fc-aou-cdr-prod.R2019Q4R3.person` person
where
person.person_id in (select criteria.person_id from (select distinct person_id, entry_date, concept_id
from `fc-aou-cdr-prod.R2019Q4R3.cb_search_all_events`
where ((is_standard = @p0_586 and concept_id in unnest(@p1_586))
)
) criteria
)
))
LIMIT ", max_number_of_rows)

YOUR_DATASET_NAME_survey_query_config <- list(
  query = list(
    parameterMode = 'NAMED',
    queryParameters = list(
      list(
        name = "p1_586",
        parameterType = list(type = "ARRAY", arrayType = list(type = "INT64")),
        parameterValue = list(arrayValues = list(list(value = 261255),list(value = 256646),list(value = 4092216),list(value = 4092217),list(value = 4311501),list(value = 255507),list(value = 257825),list(value = 4094876),list(value = 4089756),list(value = 4089754),list(value = 37110034),list(value = 36712981),list(value = 37110032),list(value = 37110033),list(value = 4246126),list(value = 762427),list(value = 4157454),list(value = 762426),list(value = 433973),list(value = 45768846),list(value = 45768844),list(value = 4093960),list(value = 46273652),list(value = 4312567),list(value = 37110031),list(value = 4112770),list(value = 36712816),list(value = 4054524),list(value = 4131454),list(value = 4110591),list(value = 258369),list(value = 4131453),list(value = 4110588),list(value = 4054526),list(value = 4110586),list(value = 258375),list(value = 4110587),list(value = 4128889),list(value = 4128888),list(value = 4128887),list(value = 4246027),list(value = 4110706),list(value = 4110705),list(value = 43530696),list(value = 4213396),list(value = 4055272),list(value = 4246805),list(value = 4247832),list(value = 4129381),list(value = 4129380),list(value = 4112738),list(value = 46270492),list(value = 36712815),list(value = 760916),list(value = 40492938),list(value = 257513),list(value = 4151250),list(value = 45768916),list(value = 4310703),list(value = 45768917),list(value = 4242353),list(value = 4115276),list(value = 45769033),list(value = 46270513),list(value = 254583),list(value = 261236),list(value = 443388),list(value = 42539251),list(value = 254591),list(value = 37109576)))
      ),
      list(
        name = "p0_586",
        parameterType = list(type = "INT64"),
        parameterValue = list(value = "1")
      )
    )
  )
)

YOUR_DATASET_NAME_survey_df <- pd$read_gbq(YOUR_DATASET_NAME_survey_sql, dialect="standard", configuration=YOUR_DATASET_NAME_survey_query_config)

head(YOUR_DATASET_NAME_survey_df, 5)

if(! "reticulate" %in% installed.packages()) { install.packages("reticulate") }
library(reticulate)
pd <- reticulate::import("pandas")

# The ‘max_number_of_rows’ parameter limits the number of rows in the query so that the result set can fit in memory.
# If you increase the limit and run into responsiveness issues, please request a VM size upgrade.
max_number_of_rows = '1000000'

# This query represents dataset "dataSet" for domain "person"
YOUR_DATASET_NAME_person_sql <- paste("SELECT person.RACE_CONCEPT_ID, person.BIRTH_DATETIME as DATE_OF_BIRTH, person.PERSON_ID, person.ETHNICITY_CONCEPT_ID, person.GENDER_CONCEPT_ID, p_race_concept.concept_name as RACE, p_gender_concept.concept_name as GENDER, p_ethnicity_concept.concept_name as ETHNICITY FROM `fc-aou-cdr-prod.R2019Q4R3.person` person LEFT JOIN `fc-aou-cdr-prod.R2019Q4R3.concept` p_race_concept on person.race_concept_id = p_race_concept.CONCEPT_ID LEFT JOIN `fc-aou-cdr-prod.R2019Q4R3.concept` p_gender_concept on person.gender_concept_id = p_gender_concept.CONCEPT_ID LEFT JOIN `fc-aou-cdr-prod.R2019Q4R3.concept` p_ethnicity_concept on person.ethnicity_concept_id = p_ethnicity_concept.CONCEPT_ID
WHERE person.PERSON_ID IN (select person_id
from `fc-aou-cdr-prod.R2019Q4R3.person` person
where
person.person_id in (select criteria.person_id from (select distinct person_id, entry_date, concept_id
from `fc-aou-cdr-prod.R2019Q4R3.cb_search_all_events`
where ((is_standard = @p0_586 and concept_id in unnest(@p1_586))
)
) criteria
)
)
LIMIT ", max_number_of_rows)

YOUR_DATASET_NAME_person_query_config <- list(
  query = list(
    parameterMode = 'NAMED',
    queryParameters = list(
      list(
        name = "p1_586",
        parameterType = list(type = "ARRAY", arrayType = list(type = "INT64")),
        parameterValue = list(arrayValues = list(list(value = 261255),list(value = 256646),list(value = 4092216),list(value = 4092217),list(value = 4311501),list(value = 255507),list(value = 257825),list(value = 4094876),list(value = 4089756),list(value = 4089754),list(value = 37110034),list(value = 36712981),list(value = 37110032),list(value = 37110033),list(value = 4246126),list(value = 762427),list(value = 4157454),list(value = 762426),list(value = 433973),list(value = 45768846),list(value = 45768844),list(value = 4093960),list(value = 46273652),list(value = 4312567),list(value = 37110031),list(value = 4112770),list(value = 36712816),list(value = 4054524),list(value = 4131454),list(value = 4110591),list(value = 258369),list(value = 4131453),list(value = 4110588),list(value = 4054526),list(value = 4110586),list(value = 258375),list(value = 4110587),list(value = 4128889),list(value = 4128888),list(value = 4128887),list(value = 4246027),list(value = 4110706),list(value = 4110705),list(value = 43530696),list(value = 4213396),list(value = 4055272),list(value = 4246805),list(value = 4247832),list(value = 4129381),list(value = 4129380),list(value = 4112738),list(value = 46270492),list(value = 36712815),list(value = 760916),list(value = 40492938),list(value = 257513),list(value = 4151250),list(value = 45768916),list(value = 4310703),list(value = 45768917),list(value = 4242353),list(value = 4115276),list(value = 45769033),list(value = 46270513),list(value = 254583),list(value = 261236),list(value = 443388),list(value = 42539251),list(value = 254591),list(value = 37109576)))
      ),
      list(
        name = "p0_586",
        parameterType = list(type = "INT64"),
        parameterValue = list(value = "1")
      )
    )
  )
)

YOUR_DATASET_NAME_person_df <- pd$read_gbq(YOUR_DATASET_NAME_person_sql, dialect="standard", configuration=YOUR_DATASET_NAME_person_query_config)

head(YOUR_DATASET_NAME_person_df, 5)
